# 🏰 Discord Calendar Bot — Herald of Happenings

**Discord Calendar Bot** is a sophisticated, AI-powered calendar assistant that brings medieval charm to your Discord server. It seamlessly integrates with Google Calendar and ICS feeds to deliver automated announcements, natural language queries, and enchanting themed greetings complete with AI-generated artwork.

> ⚔️ Built with modern Python architecture featuring `discord.py`, OpenAI GPT & DALL-E, Google Calendar API, and comprehensive error handling.

---

## ✨ Key Features

### 🗓️ **Smart Calendar Integration**
- **Multi-Source Support** — Google Calendar & ICS feeds
- **User-Tag Mapping** — Assign Discord users to calendar groups
- **Automatic Announcements** — Daily and weekly event summaries
- **Real-Time Monitoring** — Live event change notifications

### 🤖 **AI-Powered Interactions**
- **Themed Greetings** — Medieval-style messages generated by GPT
- **Custom Artwork** — DALL-E illustrations in Bayeux Tapestry style
- **Natural Language** — Query events with phrases like "tomorrow" or "next friday"
- **Smart Personas** — Royal Messenger, Court Alchemist, Bardic Chronicler

### 🎯 **User Experience**
- **Slash Commands** — Modern Discord interactions with autocomplete
- **Rich Embeds** — Beautiful, informative event displays
- **Flexible Scheduling** — Customizable announcement times
- **Debug Mode** — Enhanced logging and testing features

---

## 🚀 Available Commands

| Command | Description | Usage |
|---------|-------------|-------|
| `/herald` | Post weekly and daily events for all calendar tags | `/herald` |
| `/agenda` | Show events for natural language dates with optional tag filter | `/agenda tomorrow Bob` |
| `/events` | Display upcoming events for your assigned calendar | `/events 14` |
| `/greet` | Generate and post AI-powered morning greeting with image | `/greet` |
| `/calendars` | List available calendar sources and your access | `/calendars` |
| `/status` | Check bot status and configuration summary | `/status` |
| `/who` | Show all calendar tags and their assigned users | `/who` |
| `/reload` | Refresh calendar sources and user mappings | `/reload` |

---

## 🏗️ Modern Architecture

### Project Structure
```
📦 discord-calendar-bot/
├── 🤖 bot.py                    # Main Discord bot logic & event handlers
├── 🚀 main.py                   # Application entry point
├── 📋 requirements.txt          # Python dependencies
├── 🐳 Dockerfile               # Container configuration
├── 🔧 docker-compose.yml       # Docker orchestration
└── 📁 src/                     # Modular source code
    ├── 🧠 ai/                  # OpenAI integration
    │   ├── generator.py        # Greeting & image generation
    │   └── title_parser.py     # Event title processing
    ├── 📅 calendar/            # Calendar data management
    │   ├── events.py           # Event fetching & processing
    │   ├── sources.py          # Calendar source management
    │   └── storage.py          # Event caching & persistence
    ├── ⚙️ core/                # Core infrastructure
    │   ├── config.py           # Configuration validation
    │   ├── environment.py      # Environment variable handling
    │   └── logger.py           # Centralized logging system
    ├── 💬 discord_bot/         # Discord interactions
    │   ├── commands.py         # Slash command implementations
    │   └── embeds.py           # Rich embed generation
    ├── ⏰ scheduling/          # Task automation
    │   └── __init__.py         # Daily announcement scheduler
    └── 🔧 utils/               # Utility functions
        └── __init__.py         # Helper functions & file management
```

### Key Design Principles
- **Modular Architecture** — Clean separation of concerns
- **Error Resilience** — Comprehensive exception handling
- **Async/Await** — Modern Python concurrency patterns
- **Type Safety** — Full type hints throughout codebase
- **Logging** — Rich, structured logging with color coding
- **Configuration** — Centralized validation and management

---

## ⚙️ Environment Configuration

### Required Variables
Create a `.env` file with the following configuration:

```env
# Discord Configuration
DISCORD_BOT_TOKEN=your_discord_bot_token
ANNOUNCEMENT_CHANNEL_ID=123456789012345678

# Calendar Sources (comma-separated)
CALENDAR_SOURCES=google:calendar_id_1:TAG1,ics:https://example.com/feed.ics:TAG2

# User Mappings (comma-separated discord_user_id:TAG pairs)
USER_TAG_MAPPING=123456789012345678:TAG1,987654321098765432:TAG2

# Google Calendar Credentials
GOOGLE_APPLICATION_CREDENTIALS=service_account.json

# Optional: AI Features
OPENAI_API_KEY=your_openai_api_key
AI_TOGGLE=true

# Optional: Debug Mode
DEBUG=false
```

### Configuration Details

**Calendar Sources Format:**
- `google:calendar_id:TAG` — Google Calendar integration
- `ics:feed_url:TAG` — ICS feed integration
- Tags can be any identifier (e.g., family names, team codes)

**User Tag Mapping:**
- Maps Discord user IDs to calendar tags
- Users can only see events from their assigned tag
- Administrators can see all calendars

**AI Features:**
- Set `AI_TOGGLE=false` to disable OpenAI features
- Bot works fully without AI, just no themed greetings/images

---

## 🐳 Docker Deployment

### Quick Start
```bash
# Clone and navigate to project
git clone <repository-url>
cd discord-calendar-bot

# Configure environment
cp .env.example .env
# Edit .env with your configuration

# Add Google service account credentials
# Place service_account.json in project root

# Build and run
docker compose up --build -d

# View logs
docker compose logs -f bot
```

### Persistent Data
The bot uses volumes for persistent storage:

| Path | Purpose | Description |
|------|---------|-------------|
| `./data/logs/` | Log files | Rotating log files with timestamps |
| `./data/art/` | Generated images | AI-generated artwork cache |
| `./data/events.json` | Event cache | Cached calendar events for change detection |

### Docker Configuration
```yaml
services:
  bot:
    build: .
    volumes:
      - ./data:/data
      - ./service_account.json:/app/service_account.json:ro
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/service_account.json
    restart: unless-stopped
```

---

## 🔧 Development Setup

### Prerequisites
- Python 3.11+
- Discord Bot Token
- Google Calendar API credentials (for Google Calendar)
- OpenAI API key (optional, for AI features)

### Local Development
```bash
# Install dependencies
pip install -r requirements.txt

# Set up environment
cp .env.example .env
# Configure .env file

# Run the bot
python main.py
```

### Adding New Features
- **Commands**: Add to `src/discord_bot/commands.py`
- **AI Personalities**: Modify `src/ai/generator.py`
- **Calendar Sources**: Extend `src/calendar/sources.py`
- **Scheduled Tasks**: Update `src/scheduling/__init__.py`

---

## 🎨 AI Features

### Themed Greetings
The bot generates contextual greetings using different personas:
- **Royal Messenger** — Formal announcements
- **Court Alchemist** — Mystical prophecies
- **Bardic Chronicler** — Poetic narratives

### Generated Artwork
- **Style**: Bayeux Tapestry medieval illustrations
- **Content**: Contextual scenes based on daily events
- **Format**: PNG images attached to Discord messages
- **Caching**: Images saved to prevent regeneration

### Natural Language Processing
- **Date Parsing**: "tomorrow", "next friday", "April 10"
- **Event Summarization**: Intelligent event title processing
- **User Context**: Incorporates present Discord members

---

## 📊 Monitoring & Logging

### Log Levels
- **INFO**: General operation, successful tasks
- **WARNING**: Non-critical issues, fallback behavior
- **ERROR**: Failed operations, requires attention
- **DEBUG**: Detailed execution info (when DEBUG=true)

### Health Monitoring
- `/status` command shows bot health
- Scheduled task status tracking
- Calendar source connectivity monitoring
- Error rate tracking and reporting

### File Cleanup
- Automatic cleanup of old generated images (7 days)
- Log file rotation (14 days)
- Event cache optimization

---

## 🛠️ Troubleshooting

### Common Issues

**Bot not responding to commands:**
- Check Discord bot permissions (Send Messages, Use Slash Commands)
- Verify DISCORD_BOT_TOKEN is correct
- Ensure bot is invited to server with proper scopes

**Calendar events not showing:**
- Validate CALENDAR_SOURCES format
- Check Google service account permissions
- Verify ICS feed URLs are accessible
- Use `/calendars` command to check source status

**AI features not working:**
- Confirm OPENAI_API_KEY is set
- Check AI_TOGGLE is set to true
- Verify OpenAI API quota and billing

**Missing permissions errors:**
- Ensure Google service account has calendar read access
- Check Discord channel permissions
- Verify file system write permissions for data directory

### Debug Mode
Enable debug mode for enhanced logging:
```env
DEBUG=true
```
This provides:
- Detailed execution traces
- Faster task scheduling for testing
- Enhanced error information
- API request/response logging

---

## 🤝 Contributing

### Development Guidelines
- Follow existing code patterns and structure
- Add comprehensive error handling
- Include type hints for all functions
- Update documentation for new features
- Test with both Google Calendar and ICS sources

### Code Standards
- Use async/await for Discord and API operations
- Log important operations and errors
- Validate input parameters
- Handle network failures gracefully
- Follow PEP 8 style guidelines

---

## 📜 License

This project is open source. See individual dependencies for their respective licenses.

---

## 🏰 Example Output

The bot generates rich, themed announcements like:

> **🏰 Royal Decree from the Court Alchemist**
> 
> Hark, noble kinfolk! The stars have aligned to reveal the morrow's grand tapestry of events:
> 
> **📅 Thursday, May 29, 2025**
> - ⚔️ **Team Meeting** at 9:00 AM
> - 🎭 **Project Review** at 2:00 PM  
> - 🍺 **Social Hour** at 5:30 PM
>
> *May fortune smile upon thy endeavors!*
>
> [Generated medieval artwork attached]

----

*Built with ⚔️ by developers who believe calendars should be more exciting than spreadsheets.*